{% load static %}
<!DOCTYPE html>
<html lang="fa">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link href="https://stackpath.bootstrapcdn.com/bootstrap/4.5.2/css/bootstrap.min.css" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <title>Ø¯Ø§Ø¯Ù‡â€ŒÙ‡Ø§ÛŒ Ø¢Ø¨ Ùˆ Ù‡ÙˆØ§ â˜ï¸</title>
</head>
<body>
<div class="container mt-5">
    <h2 class="text-center mb-4">Ø¯Ø§Ø¯Ù‡â€ŒÙ‡Ø§ÛŒ Ø¢Ø¨ Ùˆ Ù‡ÙˆØ§ â˜ï¸ğŸŒ¡ï¸</h2>

    <div class="row mb-4">
        <div class="col-lg-8 offset-lg-2">
            <canvas id="temperatureChart"></canvas>
        </div>
    </div>

    <table class="table table-bordered table-hover text-center" id="weather-table">
        <thead class="thead-dark">
            <tr>
                <th>Ø´Ù‡Ø±</th>
                <th>Ø¯Ù…Ø§ (Â°C) ğŸŒ¡ï¸</th>
                <th>Ø³Ø±Ø¹Øª Ø¨Ø§Ø¯ (km/h) ğŸŒ¬ï¸</th>
                <th>ÙˆØ¶Ø¹ÛŒØª Ø¢Ø¨ Ùˆ Ù‡ÙˆØ§</th>
                <th>ØªØ§Ø±ÛŒØ® Ùˆ Ø²Ù…Ø§Ù†</th>
            </tr>
        </thead>
        <tbody id="weather-table-body">
            {% if weather_data %}
                {% for weather in weather_data %}
                <tr>
                    <td>{{ weather.city }}</td>
                    <td>{{ weather.temperature }}</td>
                    <td>{{ weather.windspeed }}</td>
                    <td>
                        {% if weather.temperature > 30 %}
                            â˜€ï¸ Ø¢ÙØªØ§Ø¨ÛŒ
                        {% elif weather.temperature > 20 %}
                            â›… Ù†ÛŒÙ…Ù‡ Ø§Ø¨Ø±ÛŒ
                        {% elif weather.temperature > 10 %}
                            â˜ï¸ Ø§Ø¨Ø±ÛŒ
                        {% else %}
                            ğŸŒ§ï¸ Ø¨Ø§Ø±Ø§Ù†ÛŒ
                        {% endif %}
                    </td>
                    <td>{{ weather.timestamp }}</td>
                </tr>
                {% endfor %}
            {% else %}
                <tr>
                    <td colspan="5">Ù‡ÛŒÚ† Ø¯Ø§Ø¯Ù‡â€ŒØ§ÛŒ Ø¨Ø±Ø§ÛŒ Ù†Ù…Ø§ÛŒØ´ ÙˆØ¬ÙˆØ¯ Ù†Ø¯Ø§Ø±Ø¯.</td>
                </tr>
            {% endif %}
        </tbody>
    </table>
</div>

<script>
    document.addEventListener("DOMContentLoaded", function () {
        const temperatures = [
            {% for weather in weather_data %}
                {{ weather.temperature }},
            {% endfor %}
        ];
        const timestamps = [
            {% for weather in weather_data %}
                "{{ weather.timestamp }}",
            {% endfor %}
        ];

        let ctx = document.getElementById('temperatureChart').getContext('2d');
        let temperatureChart = new Chart(ctx, {
            type: 'line',
            data: {
                labels: timestamps,
                datasets: [{
                    label: 'Ø¯Ù…Ø§ (Â°C) ğŸŒ¡ï¸',
                    data: temperatures,
                    backgroundColor: 'rgba(54, 162, 235, 0.2)',
                    borderColor: 'rgba(54, 162, 235, 1)',
                    borderWidth: 2,
                    fill: true,
                    tension: 0.4,
                    pointRadius: 3,
                }]
            },
            options: {
                responsive: true,
                scales: {
                    y: {
                        beginAtZero: true,
                        title: {
                            display: true,
                            text: 'Ø¯Ù…Ø§ (Â°C) ğŸŒ¡ï¸',
                        }
                    },
                    x: {
                        title: {
                            display: true,
                            text: 'ØªØ§Ø±ÛŒØ® Ùˆ Ø²Ù…Ø§Ù†',
                        }
                    }
                },
                plugins: {
                    legend: {
                        display: true,
                        position: 'top',
                    }
                }
            }
        });

        const socket = new WebSocket('ws://127.0.0.1:8000/ws/weather/{{ selected_city }}/');

        socket.onopen = function() {
            console.log('WebSocket connected');
        };

        socket.onmessage = function(event) {
            const data = JSON.parse(event.data);
            if (data.message) {
                const tableBody = document.querySelector('#weather-table-body');

                const newRow = document.createElement('tr');
                newRow.innerHTML = `
                    <td>${data.message.city}</td>
                    <td>${data.message.temperature} Â°C</td>
                    <td>${data.message.windspeed} km/h</td>
                    <td>
                        ${data.message.temperature > 30 ? "â˜€ï¸ Ø¢ÙØªØ§Ø¨ÛŒ" :
                          data.message.temperature > 20 ? "â›… Ù†ÛŒÙ…Ù‡ Ø§Ø¨Ø±ÛŒ" :
                          data.message.temperature > 10 ? "â˜ï¸ Ø§Ø¨Ø±ÛŒ" : "ğŸŒ§ï¸ Ø¨Ø§Ø±Ø§Ù†ÛŒ"}
                    </td>
                    <td>${data.message.timestamp}</td>
                `;

                tableBody.prepend(newRow);
                
                temperatureChart.data.labels.unshift(data.message.timestamp);
                temperatureChart.data.datasets[0].data.unshift(data.message.temperature);

                if (tableBody.rows.length > 5) {
                    tableBody.removeChild(tableBody.lastChild);
                }

                if (temperatureChart.data.labels.length > 5) {
                    temperatureChart.data.labels.pop();
                    temperatureChart.data.datasets[0].data.pop();
                }

                temperatureChart.update();
            } else {
                console.error("Message structure is incorrect:", data);
            }
        };

        // Ø¨Ø±ÙˆØ²Ø±Ø³Ø§Ù†ÛŒ Ø¯Ø§Ø¯Ù‡â€ŒÙ‡Ø§ Ù‡Ø± ÛŒÚ© Ø¯Ù‚ÛŒÙ‚Ù‡
        setInterval(function() {
            const latestTemperature = temperatures.length > 0 ? temperatures[temperatures.length - 1] : 0;
            const latestWindspeed = {% if weather_data %}{{ weather_data.0.windspeed }}{% else %}0{% endif %};

            const dataToSend = {
                'message': {
                    'city': '{{ selected_city }}',
                    'temperature': latestTemperature,
                    'windspeed': latestWindspeed,
                    'timestamp': new Date().toISOString()
                }
            };
            socket.send(JSON.stringify(dataToSend));
        }, 60000);
    });
</script>

</body>
</html>
